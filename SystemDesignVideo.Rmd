---
title: "System Design - Video"
author: "Terry Doner"
date: "`r format(Sys.time(), '%B %d %Y')`"
output:
  html_document:
    toc: yes
    number_sections: true
    theme: cosmo
---

```{r options, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message=FALSE)
options(knitr.table.format = "html")  
```

```{r packages }
require(readr)
require(dplyr)
require(readxl)
require(knitr)
require(kableExtra)
```

```{r functions}
source("./commonFunctions.R")
```

```{r getdata}
Tech_Inventory <- get.inventory()
network.data <- get.network()
further <- get.further()
```

# Introduction
This document provides key technical documentation for the video recording and broadcasting subsystems at UAC. This diagram provides an overview of the major components and leaves out some details.

```{r}
DiagrammeR::grViz("sdv-topology0-overview.gv")
```

Frequently throughout this document there will be a diagram or description of some aspect of the installation and following that a listing of the mentioned equipment which provide more detail on the mentioned assets.

Every significant inventory item is to have an asset tag - an actual label attached to the device. For the AV gear these tags all start with a Z. For example ZVKU-A001 is the assest tag of the kramer video matrix. Cabling aslo have a tag for the format yymm-ddxx, which is the year, month, and date followed by a sequence number.

# Video Matrix
The unit is a Kramer VS-88DT which is an 8x8 matrix and can handle both HDMI and HDBaseT formats.

It has 8 inputs and 8 outputs. It can be controlled via the buttons on the front panel or from itâ€™s built in web page.

TODO: verify this configuration

```{r}
psi <- tribble(
  ~Input, ~Usage,       ~Comment,

1, "TW Left",       "Triple wide input Left (from PP via decklink)" ,
2, "TW Centre",     "Triple wide input Centre (from PP via decklink)", 
3, "TW Right",      "Triple wide input Right (from PP via decklink)",
4, "Confidence",    "Stage display from PP for the rear projector via decklink.",
5, "VMixer Program", "Program output from Video Mixer",
6, "VMixer Aux",     "Aux output from Video Mixer",
7, "CDWU-0009",     "Video Output from Windows machine. Usually used for OBS.",
8, "PP HDMI Output", "Used for times when programs other than PP need to be displayed, for example a DVD player." 
)

pso <- tribble(
    ~Output, ~Usage,       ~Comment,
1,
"FoH Prj Left", 
"Front of House projector - East wall",
2, 
"FoH Prj Centre",
"Front of House projector - South wall",
3, 
"FoH Prj Right",
"Front of House projector - West wall",
4,
"Confidence",
"Rear Balcony Projector (stage display from PP). Lyrics for singers, etc.",
5,
"Video Mix 1",
"Video mixer input 1 (typically input 1: Propresenter Screen A)",
6,
"Video Mix 2",
"Video mixer input 2 (typically input 7: cdwu-0009)",
7,
"Lobby",
"Feed to the Lobby TV",
8,
"Nursery",
"Feed to the Nursery TV"   
)
```

## Inputs

```{r}
psi %>% 
  kable() %>%
    column_spec( 1,  bold = TRUE ) %>%
    kable_styling("striped", full_width = TRUE)
```

## Outputs
```{r}
pso %>% 
  kable() %>%
    column_spec( 1,  bold = TRUE ) %>%
    kable_styling("striped", full_width = TRUE)
```

## Configurations
The LCD display on the front of the unit report the current routing topology. The Output row shows the number of the input which is selected for that output. A '0' indicated no source has been selected. Here are two sample configurations.  

#### Normal Service Switcher Configuration 
The display should look like:

|Output|1|2|3|4|5|6|7|8|
|-|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
|Input |1|2|3|4|8|-|-|5|

```{r normal}
DiagrammeR::grViz("sdv-PSnormal.gv", height=300)
```

#### Camera On-screen Configuration  

The goal of this configuration is to get a camera image on the screen - usually the centre screen. The best method of achiving this is this

TODO: figure this out so that we can select the "Proj B" video feed on the ATEM. Atem inputs need to be Fill, Key, HDMI and "Proj B".  

* On the Video Matrix: for output 2, select ATEM Aux (input 6) 
* For ATEM Aux output select one of these two sources, depending on the intent
    + For Camera on screen select the Aux feed to come from the Program bus
    + for 'normal' mode, select the Aux ... this is incomplete

 Normal: decklink sdi6 -> VM_In2 -> VM_Out6 -> ATEM_In4 -> Aux -> VM_In6 -> VM_Out2
 
 Camera On screen: ATEM_PRG -> ATEM_AUX -> VM_In6 -> VM_Out2
 
The centre screen content can be flipped between 'normal' centre screen content from Proprestenter to ATEM Program Output by changing the Aux Bus setting on the ATEM.  
 

```{r camera}
DiagrammeR::grViz("sdv-PScamera.gv", height=300)
```

# Topologies
There are a lot of components to the system. One big diagram is daunting. It has been broken down into smaller portions to be more consumable. 

## Computer Topology

There are three computers in the system:

CDMU-A001 MacOS / ProPresenter / DVD Player
: This system runs ProPresenter and has multiple outputs:

* A built in operator display
* an hdmi output via dongle that is used for programs that need to show their output on a OS managed display. For example the DVD Player or Powerpoint
* Three outputs to the front projectors via the Decklink interface
* A Combo output of Fill and Key for the ATEM
* A stage display output to the rear display - via the decklink
* A Stage display output to the Audio Mixer in the Prayer Room via NDI 

CDWU-0009 Windows / OBS  
: This windows 10 system has a dual output video card. One is used for the operator display, and the second for presentation. It has Powerpoint for Windows installed.

CUMU-G001 MacOS / ATEM Control / OBS / Propresenter
: This system runs the ATEM switcher software, and OBS (for prayer room monitoring) and can also run things like Skype.

>todo: Confirm web presenter SDI and HDMI inputs.

>todo: is the monitor for CDWU-0009 a vga monitor? 

```{r top1}
DiagrammeR::grViz("sdv-topology1-computer.gv")

# TODO: fix the code below.

print_inv(c("CDWU-0009","CDMU-A001" , "ZVIU-E004" #"CDMU-G001" ,
			#,
           # "ZVKU-A003", "ZVKU-A001", "ZVIU-A004", "ZVKU-A002"
            ), Tech_Inventory)
```

## Projection Topology
There are four projectors in the auditorium, three FoH and one at the rear for confidence. Thet are all feed an hdmi signal via HDBaseT (Over Cat6).



```{r top2}
DiagrammeR::grViz("sdv-topology2-projection.gv")

print_inv(c("ZVKU-A001","ZVVU-A001", "ZVVU-A002", "ZVVU-A003", "ZVVU-0001"),
          Tech_Inventory)
```

## Lobby Topology
The TV in the lobby gets its content from the video matrix. For the main service it should get its feed from the video mixer program output .

There is a network cable that also runs to the lobby TV, and is for future use.

```{r l132}
DiagrammeR::grViz("sdv-topology3-lobby.gv")

print_inv(c("ZVIU-A001", "ZVKU-A001", "ZVVU-0002"), Tech_Inventory)
```

* Diagrams and charts have been updated 
* Inventory database updated with the new locations.
* need to confirm what happened to ZVIU-A001 and ZVIU-A002

## Nursery Topology
The TV in the nursery gets its content from the video matrix. For the main service it should get its feed from the video mixer program output.

```{r top3}
DiagrammeR::grViz("sdv-topology4-nursery.gv")
print_inv(c("ZVIU-A002", "ZVKU-A001",   "ZVVU-0003"), Tech_Inventory)
```

The TV has a remote control.

## Recording / Livestream Topology
The recording topology is quite complex and so it is broken up into peices.

### Inputs

A key constraint for the ATEM video mixer is that all inputs must have the same input resolution settings. We have choosen 1080p59.94. 

```{r top5a}
DiagrammeR::grViz("sdv-topology5-rec-inputs.gv", height=350)
```

### Outputs

>TODO: verify path to recorders - do they both come directly out of the ATEM, or are they daisy chained?

```{r top5b}
DiagrammeR::grViz("sdv-topology5-rec-outputs.gv", height=350)
```

### Web Presenter

> There are some details on the signal path between the Video Mixer and the Web Presenter that need to be documented.

There is only one Aux output on the ATEM (ZVKU-A003) and we need to send it to three destinations:

#. WebPresenter
#. Video Matrix
#. DeckLink

The Loop out on ZVIU-D001 and on recorder 1 is used to make this work. 
 
TODO: Document routing details between ATEM and WP. label cables. 
 
```{r topwp}
DiagrammeR::grViz("sdv-topology6-rec-wp.gv", height=350)
```

```{r}
print_inv(c("ZVKU-A004", "ZVKU-A001", "CDMU-A002",
           "ZVCU-A001", "ZVIU-C001",
           "ZVCU-A002", "ZVCU-A003", "ZVKU-A003",
           "ZVRU-A001", "ZVRU-A002", "ZVIU-A004"), Tech_Inventory)
```

# Camera Settings

The cameras recall their settings for preset 1 when powered on. This includes the video settings documented here. You should not need to adjust these regularly. If you need to reference the procedure to adjust the camera settings follows.

Each camera has a web page where we can make these updates. Open Safari and then for each camera do these steps:

#. Enter the address for a camera in the address bar. They will be on the left bookmark bar but if not, listed here as well.
```{r addresses}
network.data  %>% 
  filter(AssetTag %in% c("ZVCU-A001","ZVCU-A002","ZVCU-A003")) %>% 
  select( AssetTag, URL , Notes ) %>%
    kable(align="l") %>%
    column_spec( 1,  bold = TRUE ) %>%
    kable_styling("striped", full_width = TRUE)
```

#. At the top of the page, click on "Setting" and the on the left "Video" and the "Picture" tab
    * You should **not** be challenged for a userid and password, but if you are skip these steps and let Terry know.
#. Change Exposure Mode to "Iris Priority" 
    * This instructs the camera to we are going to set the lens aperture (Iris) otherselves, and the camera will control the other exposure settings. 
#. Change Exposure Compensatoin to "-4"
    * This instructs the camera to make the image a little bit darker than it thinks it should be. We are trying to get good face exposure.
#. Change Iris to "F1.6"
    * This forces the camera to take in the maximum amount of light.
#. Change White balance Mode to "Indoor"
    * This tells the camera that the lighting will tend to be a warmer shade than standard daylight. (There is a "Standard"). The default make skin tones too orange.
#. Change High Resolution mode to "On"
    * Use the maximum resolution the camera is capable of.
#. Change Aperture to "0"
    * Maximum light 
#. At the bottom of the page, click the "Ok" button. 
    * You will be able to see the chnages take effect.

Here is a screenshot of the page with the settings applied.

![Camera settings](../../images/sdv-camerasettings.png)

[Back to top](#top)

# Network Details

```{r} 
network.data %>% 
filter(Category=="Video") %>% 
select(Location, Usage, Device, MAC, IP, URL, Notes) %>%
kable() %>%
    column_spec( 1,  bold = TRUE ) %>%
    kable_styling("striped", full_width = TRUE)
```

# Video Equipment Inventory

```{r inventory, echo=FALSE, asis=TRUE}

items <- Tech_Inventory %>%  
          filter( Category=="Video" ,
                  InService== "Y", !is.na(AssetTag)) %>%  
          select(AssetTag) %>%
          pull()
  
print_inv(items, Tech_Inventory)
```

[Back to top](#top)

`r knit_child('FurtherInformation.Rmd', quiet=TRUE)`

[Back to top](#top)

# Document Source
This document is compiled by merging text and data together using rmarkdown. The source is found here `r getwd()` / `r knitr::current_input()`.

# Change History

`r commit.log.html( knitr::current_input() )`