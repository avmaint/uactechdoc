---
title: "Draw Node"
subtitle: A dynamically generated report focused selected items.
author: "Terry Doner"
date: last-modified
date-format: "[Last Updated on] MMMM DD YYYY"
format:
    titlepage-pdf:
      documentclass: scrbook
      classoption: ["oneside", "open=any"]
      number-sections: true
      toc: true
      lof: true
      lot: true
      titlepage: "bg-image"
      titlepage-bg-image: "./titlepage/img/corner-bg5.png" 
      titlepage-logo: "wordcloud/wordcloud-6.png"
      titlepage-header: "The Publisher"
      titlepage-footer: |
        Media Arts\
        Unionville Alliance Church\ 
      keep-tex: true	
      header-includes:
         - \usepackage{rotating}  
    html:
      toc: true
      number-sections: true
      css: styles.css
    pdf:
      number-sections: true 
      toc: true
      toc-depth: 2
      header-includes:
         - \usepackage{rotating}    
always_allow_html: yes
editor: visual
execute: 
  eval: TRUE
  echo: false
  warning: false
  message: false
---

```{r target_shortcuts}
#target<- c("2308-0002", "2308-0003" , "CDWU-A002" )
 target <- c(  "CDMU-A001",   "2308-0808")
#target <- "ZVIU-A004"
#target <- c("ZVKU-A001", "ZVIU-A001", "ZVIU-A002",
#			"ZVIU-B001", "ZVIU-A005")

daw <- c('2308-1100' ,   '2308-1102'
		, '2308-1103', '2308-1104', '2308-1105', '2308-1106', '2308-1107', '2308-1110'
		, '2308-1124', "ZVIU-D002"
		)

daw_network <- c('2308-1100'  
	, "patchpanel"
	, "modem"
	, "router","2308-1124", "NSCU-A003", "NSCU-A002"
)

youth <- c("ZAKU-A001", "2308-0906", "CDWU-A002")

aug11 <- c(     "2308-0808", 
				"2307-1827", "2307-1828",
				"ZVKU-A003")#, "ZVIU-E004" )
aug12 <- c("ZVIU-E003", "ZVIU-A008",
		   "2308-1204","2308-1205")

atem <- c( "ZVKU-A003" , "CUMU-G001")
g1 <- c(   "CUMU-G001" ,"ZVIU-G001")
  
pp <- c("CDMU-A001")

dl_atem <- c("ZVIU-E004"
			, "ZVVU-A001", "ZVVU-A002", "ZVVU-A003"
			, "ZVIU-G003", "ZVIU-G004", "ZVIU-G005"
			, "ZVIU-E001"
			, "ZVIU-E003", "ZVIU-A008"
			)

aug13 <- c("ZVKU-A001", "ZVKU-A003")
aug14 <- c("ZVKU-A001", "CDWU-0009")
vs88 <- c("ZVKU-A001", "ZVIU-C001")
nursery <- c("ZVIU-A002", "ZVVU-0002", "ZVVU-0003")

vmac <- c( "ZVIU-C002")
dl <- c("ZVIU-E004")
lobby <- c("ZVIU-A001")

dante <- c(
	"ZAMU-A001", "ZAMU-B001", "ZAMU-B002", "ZAMU-B003",
	"CUMU-E001"
)

sep16 <- c("ZVIU-A003" ,"ZVIU-E003")
sep16 <- c("ZVIU-E003","ZVIU-A008", "2308-1204","2308-1205")
atem_out <- c("ZVKU-A003","ZVIU-D001", "ZVIU-A004" , "ZVRU-A001"
			  ,"ZVIU-A005")
light1 <- c(#"2309-3004" 
		#, "2309-3003" 
		#, "2309-3002" 
		#, "2309-3001"
		  "ZLKU-C001"
		, "ZLIU-0003"
		, "ZLIU-B001"
		, "ZLIU-B002"
		, "ZLIU-B003"
		, "ZLKU-B002"
		, "ZLIU-A004"
		, "ZLIU-A001"
		, "ZLIU-A002"
		, "ZLIU-A003"
		, "2310-0220"
		, "2310-0223", "2310-0224"
		, "ZLLU-B051"
		, "ZLLU-B054"
		, 'ZLLU-B052'
		, "ZLLU-B053")

target <- c("ZVKU-A003", "ZVIU-A005", "ZVIU-E004", "CDMU-A001")
xd <- NA
```

```{r set_target}
target <- vmac # vs88 #dl_atem 
#target <- pp
#target <- daw_network 
target <- daw #atem#nursery#lobby #vs88 #dl #nursery #vs88#
target <- dante
target <- sep16

target <- wp <- c('ZVIU-A004', "ZVKU-A003")

# xd <- c("2308-1124", "ZVIU-C001", "ZVIU-A008",
# 		"ZVCU-A001", "ZVCU-A002", "ZVCU-A003",
# 		"ZVIU-E003", "CUMU-G001")
xd <- NA
xd_atem_out <- c("2308-1124","ZVIU-C001","ZVIU-E003"
				 ,"ZVIU-A008", "ZVKU-A001"
				 , "ZVIU-A005"
		,"ZVCU-A001","ZVCU-A002", "ZVCU-A003"
		, "2307-2306", "2308-1123", "ZVIU-D002")

xd_decklink_out <- c("2308-1204","2308-1205","ZVIU-E001", "ZVIU-G003", "ZVIU-G002", "ZVIU-G001", "ZVIU-G004", "ZVIU-G005")

target <- vs88
target <- c('ZVIU-D001', "2307-1821")
target <- atem_out
xd     <- xd_atem_out
xd <- c(xd_decklink_out, "CDMU-A001")
target <- c(atem_out, "ZVIU-E004", "ZVIU-A005")
#target <- "ZVIU-A005"
xd <- c("ZVCU-A003", "ZVCU-A002", "ZVCU-A001", "ZVIU-DO02", "2308-1123", "2308-1124") 

target <- c("ZVKU-A003", "ZVIU-A005", "ZVIU-E004" )
xd <- c("ZVKU-A001", "ZVIU-C001", "ZVIU-E003"
		, "ZVIU-A008"
		, "ZVIU-G001", "ZVIU-G002", "ZVIU-G003" 
		, "CUMU-E001", "CDMU-A001"
		, "2308-1123"
		, "ZVCU-A003", "ZVCU-A002", "ZVCU-A001"
		, "ZVIU-D002"
		, "ZVIU-A005"
		, "ZVIU-E005"
		, "NSCU-A004"
		, "2308-1124"
		, "ZVIU-D001", "ZVRU-A001"
		, "2308-1204", "2308-1205", "ZVIU-E001"
		, "ZVIU-G004", "ZVIU-G005" )

target <- "2308-0912"
xd <- NA
```

This report provides the details for these devices `r target` and the devices connected to them (it).

```{r packages_functions, eval=TRUE}
source('commonPackages.R')
source('commonFunctions.R')
source('commonDiagram.R')
```

```{r get_data}
inventory <- get.inventory() #; nrow(inventory)
cables <- get.cables()
```

# Diagram

```{r draw }
diag <- get_diagram(target , inventory, cables
					, exc_dev =xd
					, rankdir ="TB")

write_file(diag, "_work/diag.gv")
 
png_f <- tempfile(fileext=".png", tmpdir="_work")
dot_f <- tempfile(fileext=".gv",  tmpdir="_work")

dot <-  grViz(diag) 
write_file(diag, dot_f)

# need for pdf render
dot |> export_svg() |> charToRaw() |> rsvg_png(png_f) 
#clipr::write_clip( diag )
system(glue("open {png_f}"))
system(glue("open {dot_f}"))

```

::: {.content-visible when-format="html"}
`r dot`
:::

::: {.content-visible when-format="pdf"}
`r sprintf("\\includegraphics {%s}", png_f)`
:::

```{r calc_targets }
target_cables <- cables |>
	filter(SrcTag %in% target | DstTag %in% target)  

target_devices <- c(target_cables$SrcTag ,
	target_cables$DstTag ,
	target )
```

```{r gt_inventory}
table <- inventory |>
	filter(AssetTag %in%  target_devices) |>
	filter(!is.na(AssetTag)) |>
	select(AssetTag, Manufacturer, Model, Desc, Room, Location) |>
	gt() |>
			opt_stylize(style = 3) |>
	tab_header( glue("Connected neighbours of {paste(target, collapse=', ')}")
			  , subtitle = "They are highlighted in yellow"
			  ) |>
    tab_style(  
      
      style = list(  cell_fill(color = "yellow")  ),
      locations = cells_body(columns = AssetTag,
      					     rows = AssetTag %in% target   )
	) |>
	tab_style(
		style=list( cell_text(weight = "bold") ),
		locations=cells_body(columns=AssetTag)
	)
 # |> tab_options(
 #      page.orientation = "landscape"
 #   )
```

# Devices

::: {.content-visible when-format="pdf"}
`r sprintf("\\begin{sidewaysfigure}")` `r table` `r sprintf("\\end{sidewaysfigure}")`
:::

::: {.content-visible when-format="html"}
```{r}
table
```
:::

```{r gt_cables}
table <- target_cables |>
	select(Tag,SrcTag,SrcPort,DstTag,DstPort,Type,Length,Notes) |>
	gt() |>
			opt_stylize(style = 3) |>
	tab_header( glue("Cables connected to {paste(target, collapse=', ')}") 
			  , subtitle = "They are highlighted in yellow"
			   ) |>
    tab_style(
      style = list(
        cell_fill(color = "yellow")
        ),
      locations = cells_body(
        columns = SrcTag ,
        rows = SrcTag %in% target
    )
  )|>
    tab_style(
      style = list(
        cell_fill(color = "yellow") 
        ),
      locations = cells_body(
        columns = DstTag ,
        rows = DstTag %in% target
    )
  ) |>
	tab_style(
		style=list( cell_text(weight = "bold") ),
		locations=cells_body(columns=Tag)
	)  
```

# Cables

::: {.content-visible when-format="pdf"}
`r sprintf("\\begin{sidewaysfigure}")` `r table` `r sprintf("\\end{sidewaysfigure}")`
:::

::: {.content-visible when-format="html"}
```{r}
table
```
:::
