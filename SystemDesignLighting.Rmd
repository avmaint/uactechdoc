---
title: "System Design - Lighting"
author: "Terry Doner"
date:  "`r format(Sys.time(), '%B %d %Y')`" 
output:
  html_document:
    toc: yes
---

```{r options, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message=FALSE)
options(knitr.table.format = "html") # latex for pdf 
```

```{r packages}
require(readr)
require(dplyr)
require(readxl)
require(knitr)
require(formattable)
require(ggplot2)
require(kableExtra)
```

```{r functions}
source("commonFunctions.R")

circleFun <- function( x= 0, y=0 , r=1, npoints=50, start=0, end=2, fill="black"){
  tt <- seq(start*pi, end*pi, length.out=npoints)
  data.frame(
    x = x + r * cos(tt),
    y = y + r * sin(tt),
    fill = fill
  )
}

#convert feet and inches to decimal feet
fin <- function(f, i) {
  f + i/12
}
```

```{r getdata, include=FALSE}
NetworkInventory <- get.network()
Tech_Inventory <- get.inventory()
dmx.details <- get.dmxdetails() 
```

#Introduction
This document provides key technical documentation design for the lighting subsystems at UAC. The intended audience of thsi document are the people who need to manage and maintain the system. 

Purpose of the lighting system:

* Necessary to help the hearing impaired ( roughly 10% of the population) to lip read
* Supports video recording
* Helps draw attention to the central item – conversely makes it easier to ignore clutter
* Helps audience to focus and concentrate
* Reinforces the message (spoken or sung)

There are two mechanisms to control the lighting: 

* A touch panel located on the main floor by the south east auditorium doors. Users can select one of several preset configurations. 
* For more sophisticated control, The primary lighting control console  is an ETC ColorSource 40AV console.  It is used for all lighting operations more sophisticated than can be accomplished via the touchpad panel.

[Back to top](#top)

# Control Systems
There are three different protocols used to control the lighting levels of our major auditorium lighting systems: 

* DMX, which is the backbone protocol. We use only one DMX universe for output.
* NSI Microplex. The I/F501 provides the bridge bewteen DMX and microplex
* and KetraNet Mesh wireless

How these systems are interconnected is depcited on the diagrams below. The Microplex subsystem is shown on the DMX diagram.

The handrail lighting in the balcony and the emergency lighting are independent systems. 

### DMX Topology
The console is protected from power surges via an opto-isolator/DMX splitter.
From the opto-isolator we branch to a NSI Microplex protocol Converter (NSI IF/501) in the rack and a NSI DMX to analog converter in the electrical room.

The DMX for scrollers and rotators pass through the IF501. 

The dip switches on the IF/501 determines how it operates. It is to be programmed for DMX in and NSI microplex out.  In normal operation the power light should be solid green and the STAT should be solid yellow. The ERR light should be dark (off).
```{r top1}
DiagrammeR::grViz("sdl-topology1-control.gv")

selected.at <- c( "ZLKU-B001", "ZLIP-0001", "CDWU-0009",
                  "ZVKU-A001", "ZLIU-0003", "ZLIU-A002",
                  "ZLIU-0001", "ZLIU-0002", "ZLIU-0004",
                  "ZLEU-0001", "ZLEU-0002", 
                  "ZLEU-0003", "ZLEU-0004",
                  "ZLIU-A001", "ZLIU-A003" 
              ) %>% 
  data.frame(AssetTag=.)

merge( Tech_Inventory, selected.at) %>% 
    select(AssetTag, Manufacturer, Model, Desc ) %>%
    arrange( AssetTag ) %>%
    kable(align="l") %>%
    column_spec( 1,  bold = TRUE ) %>%
    kable_styling("striped", full_width = TRUE)
```

###KetraNet Topology

>TODO: Exact pathways for the N4 devices not yet established. These two diagrams needs to be merged.

```{r topology , echo=FALSE}
topology <- "
digraph ketra { 
graph [overlap = true, fontsize = 30, rankdir=LR 
      label='Ketra System Topology',
      fontname = Helvetica]

node [shape=Mrecord, tooltip='',  fontsize = 16, style=filled  
      fillcolor='lime']

subgraph cluster_stage { label='Stage'
   pots     [label='Ketra S38 Pots' ]
}

subgraph cluster_balcony { label= 'Balcony' 
  console  [label='Lighting Console|ZLKU-0001'    ]
  computer [label='Ketra DesignStudio|Windows|CDWU-0009' ]
  N1       [label='N1'  ]  
  subgraph cluster_rack {  label='rack' 
    dmxsplit1 [label= 'dmx Split|ZLIU-0003' ]
  }
}

subgraph cluster_avroom {  label='AV Room'
  subgraph cluster_amp { label= 'Amp Rack'
    N3       [label='N3|ZLIU-A003'  ]  
    dmxsplit2 [label= 'DMX Splitter|ZLIU-A001' ]
}
}

console -> dmxsplit1 [label='dmx']
dmxsplit1 -> dmxsplit2 [label='dmx']

dmxsplit2 -> N3  [label='dmx']
N3 -> pots [label='wireless' ]

computer -> N1 [label='usb'] 
N1 -> pots [label='wireless']

}
" 
DiagrammeR::grViz(topology)

```

```{r top2}
DiagrammeR::grViz("sdl-topology2-control.gv")

selected.at <- c(
                "ZLKU-B001", "ZLKU-B002", "CDWU-0009",
                "ZLIU-0003",
                "ZLIU-A003", "ZLIU-A002", 
              "ZLIU-B001", "ZLIU-B002", "ZLIU-B003" 
              ) %>% 
  data.frame(AssetTag=.)

merge( Tech_Inventory, selected.at) %>% 
    select(AssetTag, Manufacturer, Model, Desc ) %>%
    arrange( AssetTag ) %>%
    kable(align="l") %>%
    column_spec( 1,  bold = TRUE ) %>%
    kable_styling("striped", full_width = TRUE)

```

[Back to top](#top)



##DMX Address Map
>*Note that the DMX address for the Scrollers and Rotators are in conflict with the FoH Bar. *

```{r}
dmxmap <- tribble(
  ~DMX.Lo, ~DMX.Hi, ~Comments,
  1, 11,        "FoH Bar - Centre",

 12, 57+5-1,    "FoH Bar - East/West",

384, 384+8-1, "NRD8000 dimmers in the balcony closet",


101, 145,      "ColorSource Pars Topbar and Thrust",

151, 171,      "Ketra S38 Stage Pots",
172, 202+5-1,  "CS Pars on Floor (flares)",
219, 291+12-1,        "Wall Wash East",
303, 375+12-1,        "Wall Wash West",
86, 213+6-1,        "Wash Bulkhead",

NA, NA, "Scrollers",
NA, NA, "LMI dimmers (6x2kx2) in the electrical room",
NA , NA, "Rotators - 2 channels each."
)

dmxmap %>%
  arrange(DMX.Lo) %>%
  kable(align="l") %>%
  column_spec( 1:2,  bold = TRUE ) %>%
  kable_styling("striped", full_width = TRUE)
```

## Channel and DMX Details

> TODO: The Balcony Easy/West Bar assignments need to be updated post Aug 2018 changes.

```{r}
dmx.details %>% 
  select(Channel, DMX.Lo, Circuit, Location, Type, 
         InsturmentCount, Mode, Usage) %>%
  kable(align="l") %>%
  column_spec( 1,  bold = TRUE ) %>%
  kable_styling("striped", full_width = TRUE)
```

[Back to top](#top)

#Power Distribution Systems

>TODO: It is likely that post-August 2018 installs we will decommission the NSI and LMI dimmers. 

```{r}
DiagrammeR::grViz("sdl-topology3-power.gv")

```

## Dimmer Circuit Destinations

Lines refer to power distribution circuits from dimmers to lighting distribution points.

There is not enough power on this NRD8000 circuits to power all circuits at once.

>TODO: Review this section in light of the post-august installs. The same information is in the above diagram. 

```{r}
circuits <- tribble(
  ~Circuit.Lo, ~Circuit.Hi, ~Destination, ~Source,
   1 ,10 ,  "Balcony East Bar",  "Balcony Closet",  
   11,20 ,  "Balcony West Bar",  "Balcony Closet",
   21,32 ,	"Attic",             "Electrical Room",
   40,42 ,  "Stage Floor",       "Electrical Room"
)

circuits %>% 
  select("Circuit.Lo", 	"Circuit.Hi", "Source", "Destination") %>%
  kable(align="l") %>%
  column_spec( 1:2,  bold = TRUE ) %>%
  kable_styling("striped", full_width = TRUE)
```

[Back to top](#top)

#Lighting Plots (Table of contents placeholder)

`r knit_child('commonLightingPlots.Rmd', quiet=TRUE)`

[Back to top](#top)

#House Lighting - NEW as of Fall 2018
The house lights consists for many major components:

#. Pendants over the main floor sections
    * Each pendant has two groups of lamps. An outer group of four lamps and an inner single lamp group. The four outer lamps have a wide beam spread, the inner one is narrow. They are colour colour controllable (LED RGB).
    * The pendants over the "A" and "E" sections (extreme east and west sections) are independently controllable from the middle sections. 
    * Control Channels: 4 control channels 
    * DMX addresses: 12 DMX 
#. Pendants over the Balcony
    * These pendants have only the outer group of lamps. 
    * Control Channels: 1 channel 
    * DMX addresses: 3
#. Pots under the Balcony
    * Each pot will be an RGB lamp
    * Control Channels: 1
    * DMX addresses: 3
#. Sconse along the main floor perimeter
    * These lamps will also be RGB lamps.
    * There is also a pair of 3-way light swtiches at the entrance doors that can turn off the lights.
    * Control Channels: 1
    * DMX addresses: 3
#. Railing lights on the Balcony handrail
    * These white only strip lights are dimmable and are manually operated.
    * Control Channels: 0
    * DMX Addresses: 0
    
##Control
The house lights (except the railing) can be controlled in two ways:
 
#. Via the touchpad panel 
    * Located at the front of the auditorium, office side.
    * Allows the selection of one of five preset scenes.
    * When the console is powered on, the touchpad is disabled.
#. Via the Colorsource 40AV console
    * Located in the balcony on th erear desk.
    * many sophisticated looks can be programmed into the console.
    * When the console is powered on, the touchpad is disabled.
    
##Programming

The touchpad scenes and the DMX channel assignments are programmed via the Ketra Design Studio software which is installed on the windows computer CDWU-0009. It requires a Ketra N1 dongle to interface with the KetraNet wireless mesh network.

#House Lighting - Old Lutron

>TODO: This section needs to be removed once the 2018 upgrades are complete.

The main house lights are controlled via a control box in the balcony located on the east end of the rear desk. These are line voltage (120V ) analog controls which control the Lutron Dimmer boxes in the electrical room in four groups.

* Main House including under balcony
* Upper Balcony
* Platform Outer (Crown)
* Platform Inner

```{r}
cs = c("AssetTag","Qty"  ,
  "Manufacturer" ,
  "Model"  , 
  "Qty",
  "Location"  ,
  "Type" ,
  "Desc"     )

Tech_Inventory %>%  
          filter( Manufacturer=="Lutron" , InService== "Y") %>%  
          dplyr::select(one_of(cs)) %>% 
          kable(align="l" )  %>%
  column_spec( 1,  bold = TRUE ) %>%
  kable_styling("striped", full_width = TRUE)
```

Under independent control are the sconse lights along the perimeter walls. These are controlled via a two-way switch located by the south-east and north-east doors. The control at the south-east door has a programmable timer. The intent is to ensure that there is some lighting in the evenings between dusk and midnight to enable sfe passage.

[Back to top](#top)

#Ketra Design - Stage

```{r parms, echo=FALSE, warning=FALSE}
products <- tribble(
  ~model, ~type, ~angle, 
  "Spot",              "S",  10 ,
  "Flood",             "F",  25,  
  "Wide Flood",       "WF",  40,
  "Very Wide Flood", "VWF",  60
  )

locations <- tribble(
  ~name, ~height,
  "Bulkhead", 19+8/12,
  "InnerNorth", 22+4/12,
  "InnerSouth", 15+11/12
)

a <- 0.7 # Alpha for graphics

lamps <- merge(products, locations)  %>% mutate(rads = angle/180*pi)
```
Ketra S38 product comes in `r nrow(products)` different beam angles:
```{r, echo=FALSE}
products %>% formattable(align="l")
```
For the pots on the west side of the stage I have measured the position of each pot (give or take an inch or three). The east side is taken as the mirror image. This is a pretty good assumption but there is at least one notable exception; one pot is out of place and the stage is not symmetrical. 


```{r echo=FALSE}
# based on pots w2 and w15 - w15 on a 28" riser"
rise = 19.4 -(16.1 + 28/12)
run = 25.75 - 4.25
# use the tan rule as above, convert from radians to degrees
angle = atan(rise/run) *(180/pi)
```

```{r echo=FALSE}
lamps <- lamps %>% mutate(θ = rads/2) %>%
         mutate(beamradius = 2 * tan(θ) * height / 2 )
```
[goto top](#TOC)


```{r plan, echo=FALSE}
positions <- rbind(pots.w, pots.e, stage.refs)

l1 <- positions %>% filter(type== "ref") %>% 
  filter(name != "r3") %>% 
  filter(name != "r6") %>% 
  select(x,y)

l2 <- positions %>% filter(type== "ref") %>% 
  filter(name != "r2") %>% 
  filter(name != "r4") %>% 
  filter(name != "r5") %>% 
  select(x,y)

plan <- positions %>%
        filter(type != "ref") %>%
       # mutate(type ="S") %>%
        merge(products) %>%
        select(group, name, type, x,y, z, angle) %>%
        mutate(rads = angle/180*pi) %>%
        mutate(θ = rads/2) %>%
        mutate(beamradius = 2 * tan(θ) * z / 2 ) 

for (i in 1:nrow(plan)) {
  assign( paste0("p_", plan[i, "name"]), circleFun(x=plan[i, "x"], 
                                    y=plan[i, "y"], 
                                    r=plan[i,"beamradius"], 
                                    fill=plan[i, "type"]  ))
}

makeplot <- function(df) {
  g <- ggplot(df) + coord_equal() +
  geom_point( aes(x=x, y=y)) + 
  geom_path(data=l1, aes(x=x, y=y) ) +
  geom_path(data=l2, aes(x=x, y=y) ) +
  geom_path(data=l1, aes(x=-x, y=y) ) +
  geom_path(data=l2, aes(x=-x, y=y) )  
    
#add in beam plot
for (i in 1:nrow(df) ) {
    
   g <- g + geom_polygon(data=get(paste0("p_", df[i, "name"])) ,
                         aes(x,y, fill=fill),   alpha=a) +
        scale_size_identity()
   }
  
g <- g +   geom_text( aes(x=x, y=y, label=name), nudge_y = 1) 
return(g)
}
 
```

The basic floor plan (stage). 
```{r echo=FALSE}
df <- plan
 g <- ggplot(df) + coord_equal() +
  # geom_path(data=l1, aes(x=x, y=y) ) +
  # geom_path(data=l2, aes(x=x, y=y) ) +
  # geom_path(data=l1, aes(x=-x, y=y) ) +
  # geom_path(data=l2, aes(x=-x, y=y) ) +
  geom_text( aes(x=x, y=y, label=name) ) +
  geom_segment(data=stage.segments, aes(x=x,y=y, xend=xend, yend=yend) )  

g 
```

The design has divided up the design into `r plan %>% select(group) %>% unique() %>% count()` zones. Each group would be controlled by its own DMX channel group. 

```{r groups, echo=FALSE}
smry <- plan %>% 
  group_by(group) %>%
  summarise(Lamp_Count = n() )
   
smry %>% formattable(align="l")
```

[goto top](#TOC)

## Walls  
We need to keep the light off the screens so we need to use the spot width lamps next to the walls. With nothing else added, these will create dots on the floor.
```{r echo=FALSE}
p1 <- plan %>% 
   filter(group == "Wall" ) 

makeplot(p1 )

p1 %>% select(-rads, -θ ) %>% formattable()
```
[goto top](#TOC)

## Down Stage (Bulkhead)
The bulkhead pots can be used to light up the typical vocal area. An eight foot beam diameter should give decent coverage. With all of them on, the centre section wil be brighter than the outside.

For coverage behind the bulkhead, we can use "Two Rows"

```{r echo=FALSE}
p1 <- plan %>% 
   filter(group == "Down Stage" ) 

makeplot(p1 )

p1 %>% select(-rads, -θ ) %>% formattable()
```
[goto top](#TOC)

## Mid Stage Centre  
Could be used in combination with the bulkhead (down stage) or separately. 
```{r echo=FALSE}
p1 <- plan %>% 
   filter(group == "Mid Stage" ) 

makeplot(p1 )

p1 %>% select(-rads, -θ ) %>% formattable()
```
[goto top](#TOC)

## Up Stage Centre  
Could go with Flood or Wide Flood. The WF covers most of the riser  
```{r echo=FALSE}
p1 <- plan %>% 
   filter(group == "Up Stage" ) 

makeplot(p1 )

p1 %>% select(-rads, -θ ) %>% formattable()
```
[goto top](#TOC)

## Centre Wash
The six centre pots are in three groups to wash most of the platform. There will be a hot spot down the centre if all are on at once.

##Centre Wash Group1 
```{r echo=FALSE}
p1 <- plan %>% 
   filter(group == "Centre1"  )   

makeplot(p1)

p1 %>% select(-rads, -θ ) %>% formattable()
```

##Centre Wash Group 2

```{r echo=FALSE}
p1 <- plan %>% 
   filter(group == "Centre2"  )   

makeplot(p1)

p1 %>% select(-rads, -θ ) %>% formattable()
```
[goto top](#TOC)

##Centre Wash Group 3
The rear two (#10s) as shown in the diagram will hit the wall before the floor. It will be below the screen. If the wall splash is a visual problem we should be able to flag the fixture.

```{r echo=FALSE}
p1 <- plan %>% 
   filter(group == "Centre3"  )   

makeplot(p1)

p1 %>% select(-rads, -θ ) %>% formattable()
```
[goto top](#TOC)

#Ketra Details
```{r echo=FALSE}
rbind(pots.w, pots.e) %>% kable() %>%
  column_spec( 1,  bold = TRUE ) %>%
  kable_styling("striped", full_width = TRUE)
```
[goto top](#TOC)

##Transition Delay
The systems supports several profiles:

* RGB  - Red, Green, Blue 
* RGBW - RGB plus White
* RGBIF - RGB plus Intensity and Fade Time

The maximum delay time required to execute a lighting transition follows this formula:
$$
T = 2.7 \times {ceiling} (  \frac {N \times G} {45})
$$
where:

```{r}
df <- tribble (
  ~Variable, ~Description, ~Value,
   "",      "Number of groups on Stage", g1 <-7,
   "",      "Number of groups in House", g2 <-7,
   "G",     "Total number of groups",    G  <-(g1+g2),
   "N",     "Number of (DMX) Channels per Group", N <- 3,
  "T",     "Maximum delay time", T <- 2.7 * ceiling(N*G/45)
)

df %>% kable() %>%
  column_spec( 1 ,  bold = TRUE ) %>%
  kable_styling("striped", full_width = TRUE)
```

In this design there are `r G`  groups all using the RGB profile. The expected maximum transition time is `r T` seconds.

[goto top](#TOC)

#Appendix

#The Room
##Measurements
```{r}
  tribble(
  ~Object, ~Feet, ~Inches, 
  "SW Wall",      71,  10,  
  "South Wall",   21,  3, 
  "NW Wall",      55, 11, 
  "North Centre", 45,  2,
  "NE Back Wall",  55, 8,
  "SE Back Wall", 72, 2,
  "Front to back along centre line", 90, 2,
  "Distance (y dimension)  for corners of SW/NW wall meet",  23, 2,
  "Corner to corner distance", 123, 2
) %>% 
  mutate(Distance = Feet + Inches/12) %>%
  kable() %>%
  column_spec( 1,  bold = TRUE ) %>%
  kable_styling("striped", full_width = TRUE)
```

##Floor Plan
Reference location "r1" is the "zero" point.
```{r room, echo=FALSE}
ggplot() + 
        coord_equal() +  
        geom_segment(data=wall.segments, aes(x=x,y=y, xend=xend, yend=yend) ) + 
        geom_segment(data=balc.segments, aes(x=x,y=y, xend=xend, yend=yend) ) + 
        geom_curve(data=thrust, aes(x=x,y=y, xend=xend, yend=yend),
                   curvature=-0.3) +
        geom_point(data=all.refs, aes(x=x, y=y), color="white", size=6) +
        geom_text(data=all.refs, aes(x=x, y=y, label=name))
```

```{r l912}
all.refs %>%
  select(-group) %>%
  kable() %>%  
  column_spec( 1,  bold = TRUE ) %>%
  kable_styling("striped", full_width = TRUE)
  
```


[Back to top](#top)

# Network Details
The lighting system has few network components. RJ45 and cat6 cabling is used for some interconnects - the protocol is DMX not ethernet.

```{r} 
NetworkInventory %>% 
  filter(Category=="Lighting") %>% 
  select(Location, Usage, Device, MAC, IP, URL, Notes) %>%
  kable() %>%
  column_spec( 1,  bold = TRUE ) %>%
  kable_styling("striped", full_width = TRUE)
```

[Back to top](#top)

# Lighting Equipment Inventory

```{r inventory, echo=FALSE, asis=TRUE}
 
cs = c("AssetTag","Qty"  ,
  "Manufacturer" ,
  "Model"  , 
  "Qty",
  "Location"  ,
  "Type" ,
  "Desc"     )

Tech_Inventory %>%  
          filter( Category=="Lighting" , InService== "Y") %>%  
          dplyr::select(one_of(cs)) %>% 
          arrange(AssetTag) %>%
          kable(align="l" )  %>%
          column_spec( 1,  bold = TRUE ) %>%
          kable_styling("striped", full_width = TRUE)
```

[Back to top](#top)

#Appendix

#Accessories

## GOBO Rotators
>Needs to be updated. DMX info is out-of-date.

Each one needs two channels.

* n is a control channel, n+1 must be zero.

Intensity of zero is stop. The closer to 50 the slower it rotates. 1-49 and 50-100 rotate in opposite directions.

[Back to top](#top)

##Colour Scrollers

>To be written

### Gel String Colours

|Intensity| Name        | Rosco Number |
|---------|-------------|--------------|
|  5      | Neon Yellow |              |	 
| 13      |	Flesh       |              |	 
| 25      |	Amber       |	             |
| 33      |	Orange      |	R23          |
| 38      |	Red	        |              |
| 45      |	Lite Pink	  | R35          |
| 52      |	Magenta	    | R46          |
| 58      | Lavender    | R57          |
| 65      |	Purple      |	             |
| 73      |	Lite Blue   |              |	 
| 80	    | Warm Dark Blue	|          | 
| 85	    | Cold Dark Blue   |         |	 
| 95      |	Lite Green  |	 R88         |
| 100     |	Kelly Green |	 R94         |
|         |             |              |



`r knit_child('FurtherInformation.Rmd', quiet=TRUE)`

# Document Source
This document is compiled by merging text and data together using rmarkdown. The source is found here `r file.path(getwd(),  knitr::current_input())`.

going direct to pdf requires some trickery 'cause Diagrammer doesn't support than directly. here is a hack which would beed to be conditional on html versus pdf output.

#Change History

`r commit.log.html( knitr::current_input() )`

```{r eval=FALSE}
# seq is the input
tmp<-capture.output(rsvg_png(charToRaw(export_svg(seq)),'seq.png'))
cat('![Sequence diagram](seq.png){#fig:seq}\n\n')
 
# The next line is placed in markdown
# ![Sequence diagram](seq.png){#fig:seq}
```
